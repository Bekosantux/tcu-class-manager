# 履修管理システム

## プロジェクト概要
- **名前**: 履修管理システム (Course Management System)
- **目標**: 大学生の履修登録を支援し、時間割管理と成績管理を一元化する
- **主な機能**: 時間割表示、個人設定、履修登録支援、成績照会

## URLs
- **開発環境**: https://3000-ih83tnuyh7vfusdumgpnl-6532622b.e2b.dev
- **本番環境**: (未デプロイ)

## 最新の修正 (2025-09-05) - v2

### データベース改善
- ✅ **開講年度フィールドの追加**
  - 講義に開講年度（course_year）を追加
  - 年度別の講義管理が可能に
  - 2024年度、2025年度のテストデータを追加

### 時間割表の改善
- ✅ **列幅の固定化**
  - 時限列を64pxに固定
  - 均等な曜日列の配分
- ✅ **動的テキスト省略**
  - CSSのtext-ellipsisを使用した自動省略
  - ホバー時にツールチップで全文表示
- ✅ **学科表示の追加**
  - ヘッダーに「学部 学科 学年」形式で表示

### 登録済み講義一覧の改善
- ✅ **UI/UXの向上**
  - 交互に灰色の背景（縞模様）
  - 単位数を左詰め表示
  - 操作アイコンを中央配置
- ✅ **編集機能の拡張**
  - 開講年度の編集が可能
  - 対象学年の編集も追加
- ✅ **高度な絞り込み機能**
  - 状況（なし/取得済/履修中/履修予定/不合格）
  - 開講年度（2024/2025/2026）
  - 区分（教養/専門必修/専門選択/外国語/自由）
  - 単位数（0/0.5/1/2/3以上）

### バグ修正
- ✅ **講義編集機能の修正**
  - 更新エラーの解消（APIレスポンスの適切な処理）
  - 開講時間の編集機能を追加
  - 「+時間を追加」ボタンの動作を修正
  - 単位数0の許可

- ✅ **時間割表示の修正**
  - 年度切り替え機能の動作修正
  - 土曜日を常に表示するように変更
  - 時限列の幅を適切に調整（60px）

### UI改善
- ✅ **レイアウトの最適化**
  - 講義時間テーブルを個人設定の直上に配置
  - 文字省略の閾値を変更（講義名：20文字、担当者名：30文字）
  - 時間割の偶数行（2,4限）に薄い灰色の背景を追加
  - 時限列の幅を小さく調整

## 現在実装済みの機能

### 1. 時間割表示機能 ✅
- 4学期制（クォーター制）対応の時間割表示
- 月曜日〜土曜日、1〜5限の標準時間割グリッド
- 集中講義の別枠表示
- クォーター切り替え機能（Q1〜Q4）
- 講義詳細のポップアップ表示

### 2. 個人設定機能 ✅
- 学部・学科の選択（全8学部対応）
- 入学年度の設定
- 成績表示形式の切り替え（日本式/アルファベット式）
- 設定の保存とスキップ機能

### 3. 成績照会機能 ✅ 【NEW】
- **登録済み講義一覧**
  - 講義コード、講義名、担当者、単位数、区分の表示
  - ステータス別表示（取得済、履修中、履修予定、不合格）
  - ステータスによる色分け表示
  - フィルタリング機能
- **成績評価表示**
  - 区分別（教養、専門必修、専門選択、外国語、自由）に成績を表示
  - 添付画像のレイアウトに準拠した表示形式
  - 評価、単位数、年度、期間の表示
- **単位集計・卒業要件**
  - 区分別の取得済み単位数と履修中単位数の集計
  - 卒業要件に対する不足単位数の計算
  - GPA計算と表示

### 4. 講義編集機能 ✅ 【NEW】
- 登録済み講義の情報を個別に編集
- 講義名、担当者、教室、単位数、区分の変更
- ステータス（履修中、取得済、履修予定、不合格）の更新
- 成績評価の入力
- モーダルダイアログでの編集インターフェース

### 5. ナビゲーション機能 ✅
- 格納式ハンバーガーメニュー
- スムーズな画面遷移
- レスポンシブデザイン対応

### 6. データベース設計 ✅
- ユーザー設定テーブル
- 講義情報テーブル（区分情報追加）
- 講義スケジュールテーブル
- 履修登録テーブル（成績、GPA情報含む）
- 成績評価スケールテーブル
- 卒業要件テーブル
- テストデータの投入済み

## 機能エントリーポイント

### API エンドポイント
- `GET /api/settings` - ユーザー設定の取得
- `POST /api/settings` - ユーザー設定の保存
- `GET /api/timetable?quarter={Q1|Q2|Q3|Q4}` - 時間割データの取得
- `GET /api/courses?department={学科名}&year={学年}` - 講義一覧の取得
- `GET /api/registrations` - 登録済み講義一覧の取得 【NEW】
- `POST /api/registrations` - 履修登録
- `PUT /api/registrations/:id` - 履修情報の更新（成績、ステータス） 【NEW】
- `DELETE /api/registrations/:id` - 履修取消
- `PUT /api/courses/:id` - 講義情報の更新 【NEW】
- `GET /api/credit-summary` - 単位集計とGPAの取得 【NEW】

### 画面遷移
- `/` - メイン画面（時間割表示）
- 時間割表示 - ハンバーガーメニューから遷移
- 個人設定 - ハンバーガーメニューから遷移
- 成績照会 - ハンバーガーメニューから遷移
  - 登録済み講義一覧タブ
  - 成績評価タブ
  - 単位集計・卒業要件タブ
- 履修登録 - ハンバーガーメニューから遷移（開発中）

## 未実装の機能

### 1. 履修登録機能
- 講義検索・フィルタリング
- 必修科目の優先表示
- 単位数上限チェック（2期24単位）
- 時間割の重複チェック
- 履修条件の確認
- ドラッグ&ドロップでの履修登録

### 2. 講義データ管理
- PDFからの自動データ読み取り
- 手動での講義情報の新規登録
- 講義情報の一括インポート/エクスポート

## 推奨される次の開発ステップ

1. **履修登録機能の完全実装**
   - 講義検索画面の作成
   - 条件に基づくフィルタリング
   - ドラッグ&ドロップによる直感的な履修登録
   - リアルタイムの単位数チェック

2. **データインポート機能**
   - CSVファイルからの講義データインポート
   - PDFパース機能の実装
   - エクスポート機能

3. **通知・アラート機能**
   - 単位上限超過の警告
   - 必修科目の未履修警告
   - 卒業要件の進捗通知

4. **データの永続化とバックアップ**
   - ローカルストレージへの自動保存
   - データのエクスポート/インポート機能

## データアーキテクチャ
- **データモデル**: 
  - ユーザー設定（学部、学科、入学年度、要件）
  - 講義情報（科目コード、名称、単位数、区分、開講情報）
  - 履修登録（ユーザーと講義の関連、成績、ステータス）
  - 成績評価スケール（日本式/アルファベット式対応）
  - 卒業要件（学科別の必要単位数）
- **ストレージサービス**: Cloudflare D1（SQLiteベース）
- **データフロー**: フロントエンド → Hono API → D1 Database

## 使い方

### 初回利用時
1. サイトにアクセスすると個人設定画面が表示されます
2. 学部・学科・入学年度を選択して保存
3. 時間割画面に自動遷移

### 時間割の確認
1. 上部のドロップダウンでクォーターを選択
2. 時間割グリッドで講義を確認
3. 講義をクリックして詳細を表示

### 成績照会
1. ハンバーガーメニューから「成績照会」を選択
2. 3つのタブから表示を切り替え：
   - **登録済み講義一覧**: 全ての履修講義とステータスを確認
   - **成績評価**: 区分別に成績を確認
   - **単位集計・卒業要件**: 取得単位とGPAを確認
3. 講義の編集ボタンから個別の情報を更新

### ナビゲーション
- 左上のハンバーガーメニューから各機能へアクセス

## デプロイメント
- **プラットフォーム**: Cloudflare Pages
- **ステータス**: ❌ 未デプロイ
- **技術スタック**: Hono + TypeScript + Cloudflare D1 + TailwindCSS
- **最終更新**: 2025-09-06

## 更新履歴
- **2025-09-06 (修正対応)**: デバッグメニューのエラー修正
  - 「全データを削除してダミーデータを投入」機能を修正（APIで直接データ投入するように変更）
  - 「ダミーデータを追加」機能用の専用APIエンドポイントを追加
  - 外部キー制約エラーの対処（削除順序の最適化）
- **2025-09-06 (追加更新)**: 個人設定とデバッグ機能の追加、各種修正
  - 個人設定に「現在の学年」フィールドを追加
  - デバッグメニューページを新規作成（データの全削除、初期化、ダミーデータ投入機能）
  - 対象学年を整数型（target_year）として管理するように変更
  - 登録済み講義一覧に絞り込み機能を追加（対象学年、対象学科、受講対象）
  - 編集画面の受講対象入力をJSON形式から動的フォーム形式に改善
  - 時間割表の水色表示を削除（全て灰色で統一）
- **2025-09-06**: データベースと表示の修正
  - データベースに「受講対象」(enrollment_target)フィールドを追加
  - 時間割表の時限列幅を固定化（80px）、他の列は均等配分
  - 編集画面での開講年度と対象学年の初期値入れ替わり問題を修正
  - 編集画面に「受講対象」フィールドを追加（JSON形式で入力）
  - ダミーデータを更新して受講対象情報を含む形に

## 開発コマンド
```bash
# 開発サーバーの起動
npm run dev:sandbox

# ビルド
npm run build

# データベースマイグレーション
npm run db:migrate:local

# テストデータ投入
npm run db:seed

# データベースリセット
npm run db:reset

# 本番デプロイ
npm run deploy
```